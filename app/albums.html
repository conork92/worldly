<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Albums - Conor's Worldly</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0a1f 0%, #1a0a2e 50%, #0f0f23 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            padding: 40px;
        }

        /* Header */
        .header {
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .title {
            font-size: 42px;
            font-weight: 300;
            letter-spacing: 3px;
            text-transform: uppercase;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 16px;
            color: rgba(255,255,255,0.6);
            letter-spacing: 1px;
            margin-top: 8px;
        }

        .nav-btn {
            padding: 10px 20px;
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.35);
            border-radius: 8px;
            color: #667eea;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn:hover {
            background: rgba(102, 126, 234, 0.35);
            border-color: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: rgba(102, 126, 234, 0.4);
            border-color: #667eea;
            color: white;
        }

        .top-right-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(20, 20, 40, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px 25px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            flex: 1;
            min-width: 180px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Filters */
        .filters {
            background: rgba(20, 20, 40, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.7);
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.35);
            border-radius: 8px;
            color: white;
            font-size: 13px;
            outline: none;
            transition: all 0.3s;
        }

        .filter-group select:hover,
        .filter-group input:hover {
            background: rgba(102, 126, 234, 0.25);
            border-color: #667eea;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            background: rgba(102, 126, 234, 0.25);
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .filter-group select option {
            background: rgba(20, 20, 40, 0.95);
            color: white;
        }

        /* Albums Grid */
        .albums-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            transition: all 0.3s ease;
        }

        .albums-grid.updating {
            opacity: 0.7;
        }

        .album-card {
            background: rgba(20, 20, 40, 0.85);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            opacity: 1;
            transform: scale(1);
            animation: fadeInCard 0.4s ease-out;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeInCard {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .album-card:hover {
            transform: translateY(-4px);
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.2);
        }

        .album-image-container {
            width: 100%;
            margin-bottom: 15px;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1;
            background: rgba(102, 126, 234, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .album-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .album-card:hover .album-image {
            transform: scale(1.05);
        }

        .album-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.3);
            font-size: 48px;
        }

        .album-image-loading {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(102, 126, 234, 0.5);
        }

        .album-image-loading::after {
            content: '';
            width: 30px;
            height: 30px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .album-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .album-card:hover::before {
            opacity: 1;
        }

        .album-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
            line-height: 1.3;
        }

        .album-artist {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 15px;
        }

        .album-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: rgba(255,255,255,0.6);
        }

        .meta-label {
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 10px;
            color: rgba(255,255,255,0.4);
        }

        .meta-value {
            color: #667eea;
            font-weight: 500;
        }

        .rating {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 6px;
            font-weight: 600;
            color: #667eea;
        }

        .country-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            font-size: 11px;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .country-badge.empty {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.4);
        }

        .spotify-link {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(30, 215, 96, 0.2);
            border: 1px solid rgba(30, 215, 96, 0.4);
            border-radius: 8px;
            color: #1db954;
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .spotify-link:hover {
            background: rgba(30, 215, 96, 0.3);
            border-color: #1db954;
            color: white;
            transform: translateY(-1px);
        }

        /* Edit Album Form */
        .edit-album-form {
            background: rgba(20, 20, 40, 0.85);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        .edit-album-form.visible {
            max-height: 2000px;
            opacity: 1;
            margin-top: 0;
            margin-bottom: 30px;
            padding-top: 25px;
            padding-bottom: 25px;
        }

        .form-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group-full {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.35);
            border-radius: 8px;
            color: white;
            font-size: 13px;
            outline: none;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            background: rgba(102, 126, 234, 0.25);
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255,255,255,0.4);
        }

        .form-submit-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .form-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .form-submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .form-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
            display: none;
        }

        .form-message.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #4caf50;
            display: block;
        }

        .form-message.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            color: #f44336;
            display: block;
        }

        .comments {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            font-style: italic;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* Favorite Tracks */
        .fav-tracks-container {
            margin-bottom: 15px;
        }

        .fav-tracks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .fav-track-item {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .fav-track-item input {
            flex: 1;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.35);
            border-radius: 8px;
            color: white;
            font-size: 13px;
            outline: none;
            transition: all 0.3s;
        }

        .fav-track-item input:focus {
            background: rgba(102, 126, 234, 0.25);
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .fav-track-item input::placeholder {
            color: rgba(255,255,255,0.4);
        }

        .remove-track-btn {
            padding: 8px 12px;
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.4);
            border-radius: 8px;
            color: #f44336;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .remove-track-btn:hover {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
            color: white;
        }

        .add-track-btn {
            padding: 8px 16px;
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.4);
            border-radius: 8px;
            color: #4caf50;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .add-track-btn:hover {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4caf50;
            color: white;
        }

        /* Loading & Error States */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            letter-spacing: 2px;
        }

        .error {
            background: rgba(20, 20, 40, 0.95);
            padding: 40px;
            border-radius: 16px;
            border: 1px solid rgba(255, 68, 68, 0.5);
            text-align: center;
            max-width: 500px;
            margin: 40px auto;
        }

        .error-text {
            color: #ff4444;
            font-size: 16px;
            line-height: 1.6;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.5);
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 20px;
            }

            .title {
                font-size: 28px;
            }

            .albums-grid {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                flex-direction: column;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
    <link rel="stylesheet" href="/static/login.css">
    <script src="/static/auth.js"></script>
    <script src="/static/login.js"></script>
</head>
<body>
    <div class="header">
        <div>
            <div class="title">My Albums</div>
            <div class="subtitle">All the albums I've listened to</div>
        </div>
        <div class="top-right-nav">
            <a class="nav-btn" href="/globe">Globe</a>
            <a class="nav-btn" href="/books">Books</a>
            <a class="nav-btn" href="/quotes">Quotes</a>
            <a class="nav-btn active" href="/albums">Albums</a>
            <a class="nav-btn" href="/listening">Listening</a>
            <a class="nav-btn" href="/progress">Progress</a>
        </div>
    </div>

    <div class="stats-bar" id="stats-bar">
        <div class="stat-card">
            <div class="stat-label">Total Albums</div>
            <div class="stat-value" id="total-albums">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">With Rating</div>
            <div class="stat-value" id="rated-albums">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Haven't Listened To</div>
            <div class="stat-value" id="not-listened-albums">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Rating</div>
            <div class="stat-value" id="avg-rating">0.0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Showing</div>
            <div class="stat-value" id="showing-count">0</div>
        </div>
    </div>

    <div class="filters" id="filters">
        <div class="filter-group">
            <label for="sort-select">Sort by:</label>
            <select id="sort-select">
                <option value="listen_date_desc">Listen Date (Newest)</option>
                <option value="listen_date_asc">Listen Date (Oldest)</option>
                <option value="album_asc">Album (A-Z)</option>
                <option value="album_desc">Album (Z-A)</option>
                <option value="artist_asc">Artist (A-Z)</option>
                <option value="artist_desc">Artist (Z-A)</option>
                <option value="rating_desc">Rating (High to Low)</option>
                <option value="rating_asc">Rating (Low to High)</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-country">Filter by Country:</label>
            <select id="filter-country">
                <option value="">All Countries</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-year">Filter by Year:</label>
            <select id="filter-year">
                <option value="">All Years</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-listened">Listen Status:</label>
            <select id="filter-listened">
                <option value="">All Albums</option>
                <option value="listened">Listened To</option>
                <option value="not_listened">Not Listened To</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="search-input">Search:</label>
            <input type="text" id="search-input" placeholder="Album or artist...">
        </div>
    </div>

    <!-- Edit Album Form -->
    <div class="edit-album-form" id="edit-album-form-container">
        <div class="form-title">Edit Album</div>
        <form id="edit-album-form">
            <input type="hidden" id="album-id" name="id">
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-album-name">Album *</label>
                    <input type="text" id="edit-album-name" name="album" required>
                </div>
                <div class="form-group">
                    <label for="edit-album-artist">Artist *</label>
                    <input type="text" id="edit-album-artist" name="artist" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-album-rating">Rating</label>
                    <input type="number" id="edit-album-rating" name="rating" step="0.1" min="0" max="10" placeholder="0.0 - 10.0">
                </div>
                <div class="form-group">
                    <label for="edit-album-listen-date">Listen Date</label>
                    <input type="date" id="edit-album-listen-date" name="listen_date">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-album-country">Country</label>
                    <input type="text" id="edit-album-country" name="country_name" placeholder="Country name">
                </div>
                <div class="form-group">
                    <label for="edit-album-iso2">ISO Code 2</label>
                    <input type="text" id="edit-album-iso2" name="iso_alpha_2" placeholder="e.g., US, GB" maxlength="2">
                </div>
                <div class="form-group">
                    <label for="edit-album-iso">ISO Code 3</label>
                    <input type="text" id="edit-album-iso" name="iso_alpha_3" placeholder="e.g., USA, GBR" maxlength="3">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-album-year">Year</label>
                    <input type="number" id="edit-album-year" name="year" placeholder="Year">
                </div>
                <div class="form-group">
                    <label for="edit-album-spotify">Spotify Link</label>
                    <input type="url" id="edit-album-spotify" name="spotify_link" placeholder="https://open.spotify.com/...">
                </div>
            </div>
            <div class="form-group-full">
                <label for="edit-album-comments">Comments</label>
                <textarea id="edit-album-comments" name="comments" placeholder="Your thoughts on this album..."></textarea>
            </div>
            <div class="form-group-full fav-tracks-container">
                <label>Favorite Tracks</label>
                <div class="fav-tracks-list" id="fav-tracks-list"></div>
                <button type="button" class="add-track-btn" onclick="addFavTrack()">+ Add Track</button>
            </div>
            <button type="submit" class="form-submit-btn" id="submit-btn">Update Album</button>
            <button type="button" class="form-submit-btn" id="cancel-btn" onclick="closeEditForm()" style="background: rgba(102, 126, 234, 0.2); margin-top: 10px;">Cancel</button>
            <div class="form-message" id="form-message"></div>
        </form>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">LOADING ALBUMS</div>
    </div>

    <div class="albums-grid" id="albums-grid"></div>

    <script>
        let allAlbums = [];
        let filteredAlbums = [];
        let albumImageCache = {}; // Cache for album images

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Load albums from API
        async function loadAlbums() {
            console.log('loadAlbums called');
            try {
                console.log('Fetching from /api/albums/listened');
                const response = await fetch('/api/albums/listened');
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Data received:', data);
                
                if (data.error) {
                    throw new Error(data.message);
                }

                allAlbums = Array.isArray(data) ? data : [];
                filteredAlbums = [...allAlbums];
                console.log('Albums loaded:', allAlbums.length);
                
                updateStats();
                populateCountryFilter();
                populateYearFilter();
                renderAlbums();
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading albums:', error);
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.innerHTML = `
                        <div class="error">
                            <div class="error-text">${error.message}<br><br>Unable to connect to the API server.</div>
                        </div>
                    `;
                }
            }
        }

        // Update statistics
        function updateStats() {
            try {
                const total = allAlbums.length;
                const rated = allAlbums.filter(a => a.rating).length;
                const notListened = allAlbums.filter(a => !a.listen_date || a.listen_date.trim() === '').length;
                const ratings = allAlbums.filter(a => a.rating).map(a => parseFloat(a.rating));
                const avgRating = ratings.length > 0 
                    ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1)
                    : '0.0';

                const totalEl = document.getElementById('total-albums');
                const ratedEl = document.getElementById('rated-albums');
                const notListenedEl = document.getElementById('not-listened-albums');
                const avgRatingEl = document.getElementById('avg-rating');
                
                if (totalEl) totalEl.textContent = total;
                if (ratedEl) ratedEl.textContent = rated;
                if (notListenedEl) notListenedEl.textContent = notListened;
                if (avgRatingEl) avgRatingEl.textContent = avgRating;
            } catch (error) {
                console.error('Error in updateStats:', error);
            }
        }

        // Populate country filter
        function populateCountryFilter() {
            try {
                const countries = [...new Set(allAlbums
                    .filter(a => a.country_name && a.iso_alpha_3)
                    .map(a => a.country_name)
                    .sort())];
                
                const select = document.getElementById('filter-country');
                if (select) {
                    countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country;
                        option.textContent = country;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error in populateCountryFilter:', error);
            }
        }

        // Populate year filter
        function populateYearFilter() {
            try {
                // Extract years from both release year and listen date
                const years = new Set();
                
                allAlbums.forEach(album => {
                // Add release year if available
                if (album.year && !isNaN(album.year)) {
                    years.add(Number(album.year));
                }
                
                // Add listen date year if available
                if (album.listen_date) {
                    try {
                        const date = new Date(album.listen_date);
                        if (!isNaN(date.getTime())) {
                            const year = date.getFullYear();
                            if (year && !isNaN(year)) {
                                years.add(year);
                            }
                        }
                    } catch (e) {
                        // Try to parse as string format like "05 Jan 2026, 07:51"
                        const yearMatch = album.listen_date.match(/\b(19|20)\d{2}\b/);
                        if (yearMatch) {
                            const year = parseInt(yearMatch[0]);
                            if (year && !isNaN(year)) {
                                years.add(year);
                            }
                        }
                    }
                }
            });
            
            const sortedYears = Array.from(years).sort((a, b) => b - a); // Sort descending (newest first)
            
            const select = document.getElementById('filter-year');
            if (select) {
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    select.appendChild(option);
                });
            }
            } catch (error) {
                console.error('Error in populateYearFilter:', error);
            }
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Not set';
            // Try to parse the date string
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString; // Return as-is if not a valid date
            }
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Fetch album image from Spotify oEmbed API
        async function getSpotifyAlbumImage(spotifyLink) {
            if (!spotifyLink) return null;
            
            // Check cache first
            if (albumImageCache[spotifyLink]) {
                return albumImageCache[spotifyLink];
            }

            try {
                // Use Spotify oEmbed API (no authentication required)
                const oembedUrl = `https://open.spotify.com/oembed?url=${encodeURIComponent(spotifyLink)}`;
                const response = await fetch(oembedUrl);
                
                if (!response.ok) {
                    return null;
                }
                
                const data = await response.json();
                const imageUrl = data.thumbnail_url || null;
                
                // Cache the result
                if (imageUrl) {
                    albumImageCache[spotifyLink] = imageUrl;
                }
                
                return imageUrl;
            } catch (error) {
                console.error('Error fetching Spotify album image:', error);
                return null;
            }
        }

        // Load album images for all albums with Spotify links
        async function loadAlbumImages() {
            const albumsWithSpotify = filteredAlbums.filter(album => album.spotify_link && !album.album_image);
            
            // Load images for visible albums
            const promises = albumsWithSpotify.map(async (album) => {
                const imageUrl = await getSpotifyAlbumImage(album.spotify_link);
                if (imageUrl) {
                    // Update the album object
                    album.album_image = imageUrl;
                    
                    // Update the DOM element if it exists
                    const albumCard = document.querySelector(`[data-album-id="${album.id}"]`);
                    if (albumCard) {
                        const imageContainer = albumCard.querySelector('.album-image-container');
                        if (imageContainer) {
                            const loadingDiv = imageContainer.querySelector('.album-image-loading');
                            const placeholderDiv = imageContainer.querySelector('.album-image-placeholder');
                            
                            // Create and insert image
                            const img = document.createElement('img');
                            img.src = imageUrl;
                            img.alt = album.album || 'Album';
                            img.className = 'album-image';
                            img.onerror = function() {
                                this.style.display = 'none';
                                if (placeholderDiv) placeholderDiv.style.display = 'flex';
                            };
                            
                            if (loadingDiv) loadingDiv.style.display = 'none';
                            imageContainer.insertBefore(img, placeholderDiv);
                        }
                    }
                } else {
                    // If no image found, show placeholder
                    const albumCard = document.querySelector(`[data-album-id="${album.id}"]`);
                    if (albumCard) {
                        const imageContainer = albumCard.querySelector('.album-image-container');
                        if (imageContainer) {
                            const loadingDiv = imageContainer.querySelector('.album-image-loading');
                            const placeholderDiv = imageContainer.querySelector('.album-image-placeholder');
                            if (loadingDiv) loadingDiv.style.display = 'none';
                            if (placeholderDiv) placeholderDiv.style.display = 'flex';
                        }
                    }
                }
            });
            
            await Promise.all(promises);
        }

        // Render albums with smooth transitions
        async function renderAlbums() {
            console.log('renderAlbums called with', filteredAlbums.length, 'albums');
            const grid = document.getElementById('albums-grid');
            if (!grid) {
                console.error('albums-grid element not found!');
                return;
            }
            
            // Update showing count
            const showingCountEl = document.getElementById('showing-count');
            if (showingCountEl) {
                showingCountEl.textContent = filteredAlbums.length;
            }
            
            if (filteredAlbums.length === 0) {
                grid.innerHTML = '<div class="empty-state">No albums found matching your filters.</div>';
                return;
            }

            // Add updating class for visual feedback
            grid.classList.add('updating');
            
            // Small delay to allow transition
            setTimeout(async () => {
                const albumCards = await Promise.all(filteredAlbums.map(async (album, index) => {
                    const rating = album.rating ? `<span class="rating">‚≠ê ${album.rating}</span>` : '';
                    const country = album.country_name && album.iso_alpha_3 
                        ? `<span class="country-badge">${escapeHtml(album.country_name)}</span>`
                        : '<span class="country-badge empty">No Country</span>';
                    const spotifyLink = album.spotify_link 
                        ? `<a href="${escapeHtml(album.spotify_link)}" target="_blank" rel="noopener" class="spotify-link" onclick="event.stopPropagation()">üéµ Listen on Spotify</a>`
                        : '';
                    
                    // Album image HTML
                    const albumImageHtml = album.spotify_link 
                        ? `
                            <div class="album-image-container">
                                ${album.album_image 
                                    ? `<img src="${escapeHtml(album.album_image)}" alt="${escapeHtml(album.album || 'Album')}" class="album-image" onerror="this.style.display='none'; this.parentElement.querySelector('.album-image-placeholder').style.display='flex';">`
                                    : '<div class="album-image-loading"></div>'
                                }
                                <div class="album-image-placeholder" style="display: none;">üéµ</div>
                            </div>
                        `
                        : '';
                    
                    // If album is not listened to, we'll add suggested album later via batch loading
                    // This is done separately to improve performance
                    
                    return `
                        <div class="album-card" style="animation-delay: ${index * 0.03}s" onclick="openEditForm(${album.id})" data-album-id="${album.id}">
                            ${albumImageHtml}
                            <div class="album-title">${escapeHtml(album.album || 'Untitled')}</div>
                            <div class="album-artist">by ${escapeHtml(album.artist || 'Unknown Artist')}</div>
                            ${rating ? `<div style="margin-bottom: 10px;">${rating}</div>` : ''}
                            <div class="album-meta">
                                ${album.listen_date ? `
                                    <div class="meta-item">
                                        <span class="meta-label">Listened:</span>
                                        <span class="meta-value">${formatDate(album.listen_date)}</span>
                                    </div>
                                ` : ''}
                                ${album.year ? `
                                    <div class="meta-item">
                                        <span class="meta-label">Year:</span>
                                        <span class="meta-value">${album.year}</span>
                                    </div>
                                ` : ''}
                            </div>
                            ${album.comments ? `
                                <div class="comments">"${escapeHtml(album.comments)}"</div>
                            ` : ''}
                            ${album.fav_tracks && album.fav_tracks.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.4); margin-bottom: 6px;">Favorite Tracks:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        ${album.fav_tracks.map(track => `
                                            <span style="padding: 4px 8px; background: rgba(102, 126, 234, 0.2); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 6px; font-size: 11px; color: #667eea;">${escapeHtml(track)}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                                ${country}
                                ${spotifyLink}
                            </div>
                        </div>
                    `;
                }));
                
                grid.innerHTML = albumCards.join('');
                
                grid.classList.remove('updating');
                
                // Load album images after rendering
                loadAlbumImages();
                
                // Load suggested albums for unlistened albums in batch (after initial render for faster page load)
                loadSuggestedAlbumsBatch();
            }, 50);
        }
        
        // Cache for suggested albums to avoid repeated requests
        const suggestedAlbumsCache = {};
        
        // Load suggested albums in batch for better performance
        async function loadSuggestedAlbumsBatch() {
            // Get all unlistened albums
            const unlistenedAlbums = filteredAlbums.filter(album => !album.listen_date || album.listen_date.trim() === '');
            
            if (unlistenedAlbums.length === 0) return;
            
            // Collect unique ISO codes
            const isoCodes = [...new Set(unlistenedAlbums.map(album => {
                const iso = album.iso_alpha_3 || album.iso_code_3;
                return iso ? iso.toUpperCase().trim() : null;
            }).filter(Boolean))];
            
            // Fetch suggested albums in batch
            try {
                const response = await fetch('/api/albums/suggested-batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ iso_codes: isoCodes })
                });
                
                const suggestions = await response.json();
                
                if (suggestions && !suggestions.error) {
                    // Update each unlistened album card with its suggested album
                    unlistenedAlbums.forEach(album => {
                        const iso = (album.iso_alpha_3 || album.iso_code_3 || '').toUpperCase().trim();
                        const suggested = suggestions[iso] || suggestions['any'] || null;
                        
                        if (suggested && Object.keys(suggested).length > 0) {
                            const card = document.querySelector(`[data-album-id="${album.id}"]`);
                            if (card) {
                                const suggestedTitle = suggested.title || 'Untitled Album';
                                const suggestedArtist = suggested.artist_name || 'Unknown Artist';
                                const suggestedYear = suggested.release_year || '';
                                const suggestedGenre = suggested.genre || '';
                                
                                const suggestedHtml = `
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(102, 126, 234, 0.3);">
                                        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.5); margin-bottom: 8px;">üí° Suggested Album:</div>
                                        <div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; padding: 12px;">
                                            <div style="font-weight: 600; color: #8a9ef5; margin-bottom: 4px;">${escapeHtml(suggestedTitle)}</div>
                                            <div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">by ${escapeHtml(suggestedArtist)}</div>
                                            ${suggestedYear ? `<div style="font-size: 12px; color: rgba(255,255,255,0.5);">${suggestedYear}</div>` : ''}
                                            ${suggestedGenre ? `<div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 4px;">${escapeHtml(suggestedGenre)}</div>` : ''}
                                        </div>
                                    </div>
                                `;
                                
                                // Append to the card (before the closing div)
                                const lastChild = card.lastElementChild;
                                if (lastChild) {
                                    lastChild.insertAdjacentHTML('afterend', suggestedHtml);
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading suggested albums batch:', error);
            }
        }

        // Filter and sort albums
        function filterAndSort() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const countryFilter = document.getElementById('filter-country').value;
            const yearFilter = document.getElementById('filter-year').value;
            const listenedFilter = document.getElementById('filter-listened').value;
            const sortBy = document.getElementById('sort-select').value;

            // Filter albums
            filteredAlbums = allAlbums.filter(album => {
                const matchesSearch = !searchTerm || 
                    (album.album && album.album.toLowerCase().includes(searchTerm)) ||
                    (album.artist && album.artist.toLowerCase().includes(searchTerm));
                
                const matchesCountry = !countryFilter || album.country_name === countryFilter;
                
                // Match year filter against both release year and listen date year
                let matchesYear = !yearFilter;
                if (yearFilter) {
                    const filterYear = parseInt(yearFilter);
                    // Check release year
                    const releaseYearMatch = album.year && album.year.toString() === yearFilter;
                    // Check listen date year
                    let listenYearMatch = false;
                    if (album.listen_date) {
                        try {
                            const date = new Date(album.listen_date);
                            if (!isNaN(date.getTime())) {
                                listenYearMatch = date.getFullYear() === filterYear;
                            } else {
                                // Try to parse as string format like "05 Jan 2026, 07:51"
                                const yearMatch = album.listen_date.match(/\b(19|20)\d{2}\b/);
                                if (yearMatch && parseInt(yearMatch[0]) === filterYear) {
                                    listenYearMatch = true;
                                }
                            }
                        } catch (e) {
                            // Ignore parse errors
                        }
                    }
                    matchesYear = releaseYearMatch || listenYearMatch;
                }
                
                let matchesListened = true;
                if (listenedFilter === 'listened') {
                    matchesListened = album.listen_date && album.listen_date.trim() !== '';
                } else if (listenedFilter === 'not_listened') {
                    matchesListened = !album.listen_date || album.listen_date.trim() === '';
                }
                
                return matchesSearch && matchesCountry && matchesYear && matchesListened;
            });

            // Sort
            filteredAlbums.sort((a, b) => {
                switch(sortBy) {
                    case 'listen_date_desc':
                        return new Date(b.listen_date || 0) - new Date(a.listen_date || 0);
                    case 'listen_date_asc':
                        return new Date(a.listen_date || 0) - new Date(b.listen_date || 0);
                    case 'album_asc':
                        return (a.album || '').localeCompare(b.album || '');
                    case 'album_desc':
                        return (b.album || '').localeCompare(a.album || '');
                    case 'artist_asc':
                        return (a.artist || '').localeCompare(b.artist || '');
                    case 'artist_desc':
                        return (b.artist || '').localeCompare(a.artist || '');
                    case 'rating_desc':
                        return (parseFloat(b.rating) || 0) - (parseFloat(a.rating) || 0);
                    case 'rating_asc':
                        return (parseFloat(a.rating) || 0) - (parseFloat(b.rating) || 0);
                    default:
                        return 0;
                }
            });

            // Render with smooth transition
            renderAlbums();
        }

        // Event listeners with debouncing for search
        let searchTimeout;
        document.getElementById('sort-select').addEventListener('change', filterAndSort);
        document.getElementById('filter-country').addEventListener('change', filterAndSort);
        document.getElementById('filter-year').addEventListener('change', filterAndSort);
        document.getElementById('filter-listened').addEventListener('change', filterAndSort);
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterAndSort, 300); // Debounce search for 300ms
        });

        // Open edit form with album data
        function openEditForm(albumId) {
            const album = allAlbums.find(a => a.id === albumId);
            if (!album) return;

            // Format date for input field (YYYY-MM-DD)
            let formattedDate = '';
            if (album.listen_date) {
                try {
                    const date = new Date(album.listen_date);
                    if (!isNaN(date.getTime())) {
                        formattedDate = date.toISOString().split('T')[0];
                    } else {
                        // Try to parse as YYYY-MM-DD or other formats
                        const parts = album.listen_date.split(/[-/]/);
                        if (parts.length === 3) {
                            // Assume format might be MM/DD/YYYY or DD/MM/YYYY
                            formattedDate = album.listen_date;
                        }
                    }
                } catch (e) {
                    formattedDate = album.listen_date;
                }
            }

            // Populate form fields
            document.getElementById('album-id').value = album.id || '';
            document.getElementById('edit-album-name').value = album.album || '';
            document.getElementById('edit-album-artist').value = album.artist || '';
            document.getElementById('edit-album-rating').value = album.rating || '';
            document.getElementById('edit-album-listen-date').value = formattedDate;
            document.getElementById('edit-album-country').value = album.country_name || '';
            document.getElementById('edit-album-iso2').value = (album.iso_alpha_2 || '').toUpperCase();
            document.getElementById('edit-album-iso').value = (album.iso_alpha_3 || '').toUpperCase();
            document.getElementById('edit-album-year').value = album.year || '';
            document.getElementById('edit-album-spotify').value = album.spotify_link || '';
            document.getElementById('edit-album-comments').value = album.comments || '';
            
            // Populate fav_tracks
            const favTracksList = document.getElementById('fav-tracks-list');
            favTracksList.innerHTML = '';
            const favTracks = album.fav_tracks || [];
            if (favTracks.length > 0) {
                favTracks.forEach(track => {
                    addFavTrack(track);
                });
            } else {
                // Add one empty track input by default
                addFavTrack();
            }

            // Show form
            const formContainer = document.getElementById('edit-album-form-container');
            formContainer.classList.add('visible');
            
            // Scroll to form
            setTimeout(() => {
                formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        // Add favorite track input
        function addFavTrack(trackValue = '') {
            const favTracksList = document.getElementById('fav-tracks-list');
            const trackItem = document.createElement('div');
            trackItem.className = 'fav-track-item';
            const trackId = Date.now() + Math.random();
            trackItem.innerHTML = `
                <input type="text" class="fav-track-input" placeholder="Track name..." value="${escapeHtml(trackValue)}">
                <button type="button" class="remove-track-btn" onclick="removeFavTrack(this)">Remove</button>
            `;
            favTracksList.appendChild(trackItem);
        }

        // Remove favorite track input
        function removeFavTrack(btn) {
            btn.parentElement.remove();
        }

        // Close edit form
        function closeEditForm() {
            const formContainer = document.getElementById('edit-album-form-container');
            formContainer.classList.remove('visible');
            document.getElementById('edit-album-form').reset();
            document.getElementById('fav-tracks-list').innerHTML = '';
            document.getElementById('form-message').className = 'form-message';
            document.getElementById('form-message').textContent = '';
        }

        // Handle edit album form submission
        document.getElementById('edit-album-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const messageDiv = document.getElementById('form-message');
            const albumId = document.getElementById('album-id').value;
            
            if (!albumId) {
                messageDiv.className = 'form-message error';
                messageDiv.textContent = 'Error: Album ID is missing';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            messageDiv.className = 'form-message';
            messageDiv.textContent = '';

            // Collect form data
            const favTracksInputs = document.querySelectorAll('.fav-track-input');
            const favTracks = Array.from(favTracksInputs)
                .map(input => input.value.trim())
                .filter(track => track !== '');

            const formData = {
                album: document.getElementById('edit-album-name').value.trim(),
                artist: document.getElementById('edit-album-artist').value.trim(),
                rating: document.getElementById('edit-album-rating').value ? parseFloat(document.getElementById('edit-album-rating').value) : null,
                listen_date: document.getElementById('edit-album-listen-date').value || null,
                country_name: document.getElementById('edit-album-country').value.trim() || null,
                iso_alpha_2: document.getElementById('edit-album-iso2').value.trim().toUpperCase() || null,
                iso_alpha_3: document.getElementById('edit-album-iso').value.trim().toUpperCase() || null,
                year: document.getElementById('edit-album-year').value ? parseInt(document.getElementById('edit-album-year').value) : null,
                spotify_link: document.getElementById('edit-album-spotify').value.trim() || null,
                comments: document.getElementById('edit-album-comments').value.trim() || null,
                fav_tracks: favTracks.length > 0 ? favTracks : null
            };

            // Remove null/empty values (but keep empty arrays)
            Object.keys(formData).forEach(key => {
                if (formData[key] === null || formData[key] === '') {
                    delete formData[key];
                }
            });
            
            // If fav_tracks is an empty array, set it to null or remove it
            if (formData.fav_tracks && formData.fav_tracks.length === 0) {
                delete formData.fav_tracks;
            }

            try {
                const response = await authenticatedFetch(`/api/albums/listened/${albumId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to update album');
                }

                // Show success message
                messageDiv.className = 'form-message success';
                messageDiv.textContent = 'Album updated successfully!';
                
                // Reload albums to show the updated data
                setTimeout(() => {
                    loadAlbums();
                    closeEditForm();
                }, 1500);

            } catch (error) {
                console.error('Error updating album:', error);
                messageDiv.className = 'form-message error';
                messageDiv.textContent = `Error: ${error.message}`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Album';
            }
        });

        // Load albums on page load
        console.log('Page loaded, calling loadAlbums');
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadAlbums);
        } else {
            loadAlbums();
        }
    </script>
</body>
</html>

