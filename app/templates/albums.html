<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Albums - Conor's Worldly</title>
    <link rel="stylesheet" href="/static/css/worldly.css">
    <style>
        /* Albums page ‚Äì grid, cards, edit form */
        .albums-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
        }

        .albums-grid.updating { opacity: 0.65; transition: opacity 0.2s ease; }

        .album-card {
            background: rgba(255,255,255,0.04);
            padding: 0;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.07);
            transition: transform 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
            overflow: visible;
            animation: fadeIn 0.4s ease-out;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .album-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255,255,255,0.12);
            box-shadow: 0 20px 40px rgba(0,0,0,0.35);
        }

        .album-image-container {
            width: 100%;
            aspect-ratio: 1;
            overflow: hidden;
            background: rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px 16px 0 0;
        }

        .album-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .album-card:hover .album-image { transform: scale(1.04); }

        .album-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.25);
            font-size: 3rem;
        }

        .album-image-loading {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .album-image-loading::after {
            content: '';
            width: 28px;
            height: 28px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top-color: rgba(88, 101, 242, 0.6);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .album-card > *:not(.album-image-container) {
            padding-left: 20px;
            padding-right: 20px;
        }
        .album-card > .album-meta { padding-left: 20px; padding-right: 20px; padding-top: 14px; }

        .album-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 16px;
            margin-bottom: 4px;
            color: #fff;
            letter-spacing: -0.02em;
            line-height: 1.35;
        }

        .album-artist {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.6);
            margin-bottom: 12px;
        }

        .album-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            margin-top: 12px;
            padding: 14px 20px 0;
            border-top: 1px solid rgba(255,255,255,0.07);
        }

        .meta-item { font-size: 0.82rem; color: rgba(255,255,255,0.55); }
        .meta-label { font-size: 0.72rem; color: rgba(255,255,255,0.45); margin-right: 4px; }
        .meta-value { color: rgba(255,255,255,0.85); font-weight: 600; }

        .album-rating-wrap { margin-bottom: 12px; }

        .rating {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 8px;
            font-size: 0.82rem;
            font-weight: 700;
            color: #fcd34d;
        }

        .country-badge {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255,255,255,0.85);
        }

        .country-badge.empty {
            background: transparent;
            border-color: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.45);
        }

        .spotify-link {
            display: inline-block;
            padding: 8px 14px;
            background: rgba(29, 185, 84, 0.18);
            border: 1px solid rgba(29, 185, 84, 0.35);
            border-radius: 10px;
            color: #22c55e;
            text-decoration: none;
            font-size: 0.82rem;
            font-weight: 600;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .spotify-link:hover {
            background: rgba(29, 185, 84, 0.28);
            border-color: rgba(29, 185, 84, 0.5);
        }

        /* Card sections: fav tracks, footer, suggested - keep all visible */
        .album-fav-tracks {
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid rgba(255,255,255,0.08);
            padding-left: 20px;
            padding-right: 20px;
        }
        .album-fav-tracks-label {
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            margin-bottom: 8px;
        }
        .album-fav-tracks-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .album-fav-track-tag {
            padding: 6px 12px;
            background: rgba(88, 101, 242, 0.2);
            border: 1px solid rgba(88, 101, 242, 0.35);
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #a5b4fc;
        }

        .album-footer {
            margin-top: 14px;
            padding: 0 20px 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .album-suggested {
            margin-top: 14px;
            padding: 14px 20px 20px;
            border-top: 1px solid rgba(88, 101, 242, 0.2);
        }
        .album-suggested-label {
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.55);
            margin-bottom: 10px;
        }
        .album-suggested-card {
            background: rgba(88, 101, 242, 0.1);
            border: 1px solid rgba(88, 101, 242, 0.25);
            border-radius: 12px;
            padding: 14px;
        }
        .album-suggested-title {
            font-weight: 700;
            font-size: 0.95rem;
            color: #a5b4fc;
            margin-bottom: 4px;
        }
        .album-suggested-artist {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.75);
            margin-bottom: 6px;
        }
        .album-suggested-meta {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.5);
            margin-top: 4px;
        }

        /* Edit form */
        .edit-album-form {
            background: rgba(255,255,255,0.04);
            padding: 28px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 32px;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.35s ease, opacity 0.25s ease, padding 0.25s ease, margin 0.25s ease;
        }

        .edit-album-form.visible {
            max-height: 2000px;
            opacity: 1;
            padding: 28px;
            margin-bottom: 32px;
        }

        .form-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #fff;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group-full { margin-bottom: 16px; }

        .form-group label {
            display: block;
            font-size: 0.78rem;
            font-weight: 600;
            color: rgba(255,255,255,0.55);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #e8e8ec;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s ease;
            font-family: inherit;
        }

        .form-group textarea { min-height: 88px; resize: vertical; }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: rgba(88, 101, 242, 0.5);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder { color: rgba(255,255,255,0.4); }

        .form-submit-btn {
            padding: 14px 22px;
            background: rgba(88, 101, 242, 0.25);
            border: 1px solid rgba(88, 101, 242, 0.4);
            border-radius: 10px;
            color: #c7d2fe;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
            width: 100%;
        }

        .form-submit-btn:hover {
            background: rgba(88, 101, 242, 0.35);
            border-color: rgba(88, 101, 242, 0.5);
        }

        .form-submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .form-cancel-btn {
            margin-top: 12px;
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.8);
        }
        .form-cancel-btn:hover {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.18);
        }

        .form-message {
            margin-top: 14px;
            padding: 12px 14px;
            border-radius: 10px;
            font-size: 0.88rem;
            text-align: center;
            display: none;
        }

        .form-message.success {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.35);
            color: #4ade80;
            display: block;
        }

        .form-message.error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.35);
            color: #f87171;
            display: block;
        }

        .comments {
            font-size: 0.88rem;
            color: rgba(255,255,255,0.65);
            font-style: italic;
            margin-top: 12px;
            padding: 12px 20px 14px;
            border-top: 1px solid rgba(255,255,255,0.07);
        }

        .fav-tracks-container { margin-bottom: 16px; }
        .fav-tracks-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .fav-track-item { display: flex; gap: 10px; align-items: center; }

        .fav-track-item input {
            flex: 1;
            padding: 10px 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #e8e8ec;
            font-size: 0.9rem;
            outline: none;
        }

        .fav-track-item input:focus { border-color: rgba(88, 101, 242, 0.5); }
        .fav-track-item input::placeholder { color: rgba(255,255,255,0.4); }

        .remove-track-btn {
            padding: 10px 14px;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            color: #f87171;
            cursor: pointer;
            font-size: 0.82rem;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .remove-track-btn:hover { background: rgba(239, 68, 68, 0.25); }

        .add-track-btn {
            padding: 10px 16px;
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 10px;
            color: #4ade80;
            cursor: pointer;
            font-size: 0.82rem;
            font-weight: 600;
            transition: background 0.2s ease;
            margin-top: 8px;
        }

        .add-track-btn:hover { background: rgba(34, 197, 94, 0.25); }

        @media (max-width: 768px) {
            .albums-grid { grid-template-columns: 1fr; gap: 20px; }
        }
    </style>
    <link rel="stylesheet" href="/static/css/login.css">
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/login.js"></script>
</head>
<body>
    <div class="header">
        <div>
            <div class="title">My Albums</div>
            <div class="subtitle">All the albums I've listened to</div>
        </div>
        <div class="top-right-nav">
            <a class="nav-btn" href="/globe">Globe</a>
            <a class="nav-btn" href="/books">Books</a>
            <a class="nav-btn" href="/movies">Movies</a>
            <a class="nav-btn" href="/quotes">Quotes</a>
            <a class="nav-btn active" href="/albums">Albums</a>
            <a class="nav-btn" href="/listening">Listening</a>
            <a class="nav-btn" href="/exercise">Exercise</a>
            <a class="nav-btn" href="/progress">Progress</a>
        </div>
    </div>

    <div class="stats-bar" id="stats-bar">
        <div class="stat-card">
            <div class="stat-label">Total Albums</div>
            <div class="stat-value" id="total-albums">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">With Rating</div>
            <div class="stat-value" id="rated-albums">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Haven't Listened To</div>
            <div class="stat-value" id="not-listened-albums">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Rating</div>
            <div class="stat-value" id="avg-rating">0.0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Showing</div>
            <div class="stat-value" id="showing-count">0</div>
        </div>
    </div>

    <div class="filters" id="filters">
        <div class="filter-group">
            <label for="sort-select">Sort by:</label>
            <select id="sort-select">
                <option value="country_asc" selected>Country (A-Z)</option>
                <option value="country_desc">Country (Z-A)</option>
                <option value="listen_date_desc">Listen Date (Newest)</option>
                <option value="listen_date_asc">Listen Date (Oldest)</option>
                <option value="album_asc">Album (A-Z)</option>
                <option value="album_desc">Album (Z-A)</option>
                <option value="artist_asc">Artist (A-Z)</option>
                <option value="artist_desc">Artist (Z-A)</option>
                <option value="rating_desc">Rating (High to Low)</option>
                <option value="rating_asc">Rating (Low to High)</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-country">Filter by Country:</label>
            <select id="filter-country">
                <option value="">All Countries</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-year">Filter by Year:</label>
            <select id="filter-year">
                <option value="">All Years</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-listened">Listen Status:</label>
            <select id="filter-listened">
                <option value="">All Albums</option>
                <option value="listened">Listened To</option>
                <option value="not_listened">Not Listened To</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="search-input">Search:</label>
            <input type="text" id="search-input" placeholder="Album or artist...">
        </div>
    </div>

    <!-- Edit Album Form -->
    <div class="edit-album-form" id="edit-album-form-container">
        <div class="form-title">Edit Album</div>
        <form id="edit-album-form">
            <input type="hidden" id="album-id" name="id">
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-album-name">Album *</label>
                    <input type="text" id="edit-album-name" name="album" required>
                </div>
                <div class="form-group">
                    <label for="edit-album-artist">Artist *</label>
                    <input type="text" id="edit-album-artist" name="artist" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-album-rating">Rating</label>
                    <input type="number" id="edit-album-rating" name="rating" step="0.1" min="0" max="10" placeholder="0.0 - 10.0">
                </div>
                <div class="form-group">
                    <label for="edit-album-listen-date">Listen Date</label>
                    <input type="date" id="edit-album-listen-date" name="listen_date">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-album-country">Country</label>
                    <input type="text" id="edit-album-country" name="country_name" placeholder="Country name">
                </div>
                <div class="form-group">
                    <label for="edit-album-iso2">ISO Code 2</label>
                    <input type="text" id="edit-album-iso2" name="iso_alpha_2" placeholder="e.g., US, GB" maxlength="2">
                </div>
                <div class="form-group">
                    <label for="edit-album-iso">ISO Code 3</label>
                    <input type="text" id="edit-album-iso" name="iso_alpha_3" placeholder="e.g., USA, GBR" maxlength="3">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-album-year">Year</label>
                    <input type="number" id="edit-album-year" name="year" placeholder="Year">
                </div>
                <div class="form-group">
                    <label for="edit-album-spotify">Spotify Link</label>
                    <input type="url" id="edit-album-spotify" name="spotify_link" placeholder="https://open.spotify.com/...">
                </div>
            </div>
            <div class="form-group-full">
                <label for="edit-album-comments">Comments</label>
                <textarea id="edit-album-comments" name="comments" placeholder="Your thoughts on this album..."></textarea>
            </div>
            <div class="form-group-full fav-tracks-container">
                <label>Favorite Tracks</label>
                <div class="fav-tracks-list" id="fav-tracks-list"></div>
                <button type="button" class="add-track-btn" onclick="addFavTrack()">+ Add Track</button>
            </div>
            <button type="submit" class="form-submit-btn" id="submit-btn">Update Album</button>
            <button type="button" class="form-submit-btn form-cancel-btn" id="cancel-btn" onclick="closeEditForm()">Cancel</button>
            <div class="form-message" id="form-message"></div>
        </form>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">LOADING ALBUMS</div>
    </div>

    <div class="albums-grid" id="albums-grid"></div>

    <script>
        let allAlbums = [];
        let filteredAlbums = [];
        let albumImageCache = {}; // Cache for album images

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Load albums from API
        async function loadAlbums(preserveFilters = false) {
            console.log('loadAlbums called', preserveFilters ? '(preserving filters)' : '');
            
            // Save current filter state if preserving
            let savedFilters = null;
            if (preserveFilters) {
                savedFilters = {
                    search: document.getElementById('search-input').value,
                    country: document.getElementById('filter-country').value,
                    year: document.getElementById('filter-year').value,
                    listened: document.getElementById('filter-listened').value,
                    sort: document.getElementById('sort-select').value
                };
            }
            
            try {
                console.log('Fetching from /api/albums/listened');
                const response = await fetch('/api/albums/listened');
                console.log('Response status:', response.status);
                let data;
                try {
                    data = await response.json();
                } catch (_) {
                    data = {};
                }
                console.log('Data received:', data);

                if (!response.ok) {
                    let msg = data.detail || data.message || (Array.isArray(data) ? null : data.error) || `HTTP ${response.status}`;
                    if (Array.isArray(msg)) msg = msg.map(m => m.msg || m).join('; ');
                    throw new Error(msg || 'Server error');
                }
                if (data && data.error) {
                    throw new Error(data.message || data.error);
                }

                allAlbums = Array.isArray(data) ? data : [];
                filteredAlbums = [...allAlbums];
                console.log('Albums loaded:', allAlbums.length);
                
                updateStats();
                populateCountryFilter();
                populateYearFilter();
                
                // Restore filter state if preserving
                if (preserveFilters && savedFilters) {
                    document.getElementById('search-input').value = savedFilters.search;
                    document.getElementById('filter-country').value = savedFilters.country;
                    document.getElementById('filter-year').value = savedFilters.year;
                    document.getElementById('filter-listened').value = savedFilters.listened;
                    document.getElementById('sort-select').value = savedFilters.sort;
                    // Apply filters and sort
                    filterAndSort();
                } else {
                    // Apply default sort (Country A-Z) on initial load
                    filterAndSort();
                }
                
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading albums:', error);
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    const isNetworkError = error.message === 'Failed to fetch' || error.name === 'TypeError';
                    const hint = isNetworkError
                        ? ' Make sure the app server is running (e.g. from the app directory: uvicorn main:app --reload).'
                        : '';
                    loadingEl.innerHTML = `
                        <div class="error">
                            <div class="error-text">${escapeHtml(error.message)}${hint ? '<br><br>' + escapeHtml(hint) : ''}</div>
                        </div>
                    `;
                }
            }
        }

        // Update statistics
        function updateStats() {
            try {
                const total = allAlbums.length;
                const rated = allAlbums.filter(a => a.rating).length;
                const notListened = allAlbums.filter(a => !a.listen_date || a.listen_date.trim() === '').length;
                const ratings = allAlbums.filter(a => a.rating).map(a => parseFloat(a.rating));
                const avgRating = ratings.length > 0 
                    ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1)
                    : '0.0';

                const totalEl = document.getElementById('total-albums');
                const ratedEl = document.getElementById('rated-albums');
                const notListenedEl = document.getElementById('not-listened-albums');
                const avgRatingEl = document.getElementById('avg-rating');
                
                if (totalEl) totalEl.textContent = total;
                if (ratedEl) ratedEl.textContent = rated;
                if (notListenedEl) notListenedEl.textContent = notListened;
                if (avgRatingEl) avgRatingEl.textContent = avgRating;
            } catch (error) {
                console.error('Error in updateStats:', error);
            }
        }

        // Populate country filter
        function populateCountryFilter() {
            try {
                const countries = [...new Set(allAlbums
                    .filter(a => a.country_name && a.iso_alpha_3)
                    .map(a => a.country_name)
                    .sort())];
                
                const select = document.getElementById('filter-country');
                if (select) {
                    countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country;
                        option.textContent = country;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error in populateCountryFilter:', error);
            }
        }

        // Populate year filter
        function populateYearFilter() {
            try {
                // Extract years from both release year and listen date
                const years = new Set();
                
                allAlbums.forEach(album => {
                // Add release year if available
                if (album.year && !isNaN(album.year)) {
                    years.add(Number(album.year));
                }
                
                // Add listen date year if available
                if (album.listen_date) {
                    try {
                        const date = new Date(album.listen_date);
                        if (!isNaN(date.getTime())) {
                            const year = date.getFullYear();
                            if (year && !isNaN(year)) {
                                years.add(year);
                            }
                        }
                    } catch (e) {
                        // Try to parse as string format like "05 Jan 2026, 07:51"
                        const yearMatch = album.listen_date.match(/\b(19|20)\d{2}\b/);
                        if (yearMatch) {
                            const year = parseInt(yearMatch[0]);
                            if (year && !isNaN(year)) {
                                years.add(year);
                            }
                        }
                    }
                }
            });
            
            const sortedYears = Array.from(years).sort((a, b) => b - a); // Sort descending (newest first)
            
            const select = document.getElementById('filter-year');
            if (select) {
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    select.appendChild(option);
                });
            }
            } catch (error) {
                console.error('Error in populateYearFilter:', error);
            }
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Not set';
            // Try to parse the date string
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString; // Return as-is if not a valid date
            }
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Fetch album image from Spotify oEmbed API
        async function getSpotifyAlbumImage(spotifyLink) {
            if (!spotifyLink) return null;
            
            // Check cache first
            if (albumImageCache[spotifyLink]) {
                return albumImageCache[spotifyLink];
            }

            try {
                // Use Spotify oEmbed API (no authentication required)
                const oembedUrl = `https://open.spotify.com/oembed?url=${encodeURIComponent(spotifyLink)}`;
                const response = await fetch(oembedUrl);
                
                if (!response.ok) {
                    return null;
                }
                
                const data = await response.json();
                const imageUrl = data.thumbnail_url || null;
                
                // Cache the result
                if (imageUrl) {
                    albumImageCache[spotifyLink] = imageUrl;
                }
                
                return imageUrl;
            } catch (error) {
                console.error('Error fetching Spotify album image:', error);
                return null;
            }
        }

        // Load album images for all albums with Spotify links
        async function loadAlbumImages() {
            const albumsWithSpotify = filteredAlbums.filter(album => album.spotify_link && !album.album_image);
            
            // Load images for visible albums
            const promises = albumsWithSpotify.map(async (album) => {
                const imageUrl = await getSpotifyAlbumImage(album.spotify_link);
                if (imageUrl) {
                    // Update the album object
                    album.album_image = imageUrl;
                    
                    // Update the DOM element if it exists
                    const albumCard = document.querySelector(`[data-album-id="${album.id}"]`);
                    if (albumCard) {
                        const imageContainer = albumCard.querySelector('.album-image-container');
                        if (imageContainer) {
                            const loadingDiv = imageContainer.querySelector('.album-image-loading');
                            const placeholderDiv = imageContainer.querySelector('.album-image-placeholder');
                            
                            // Create and insert image
                            const img = document.createElement('img');
                            img.src = imageUrl;
                            img.alt = album.album || 'Album';
                            img.className = 'album-image';
                            img.onerror = function() {
                                this.style.display = 'none';
                                if (placeholderDiv) placeholderDiv.style.display = 'flex';
                            };
                            
                            if (loadingDiv) loadingDiv.style.display = 'none';
                            imageContainer.insertBefore(img, placeholderDiv);
                        }
                    }
                } else {
                    // If no image found, show placeholder
                    const albumCard = document.querySelector(`[data-album-id="${album.id}"]`);
                    if (albumCard) {
                        const imageContainer = albumCard.querySelector('.album-image-container');
                        if (imageContainer) {
                            const loadingDiv = imageContainer.querySelector('.album-image-loading');
                            const placeholderDiv = imageContainer.querySelector('.album-image-placeholder');
                            if (loadingDiv) loadingDiv.style.display = 'none';
                            if (placeholderDiv) placeholderDiv.style.display = 'flex';
                        }
                    }
                }
            });
            
            await Promise.all(promises);
        }

        // Render albums with smooth transitions
        async function renderAlbums() {
            console.log('renderAlbums called with', filteredAlbums.length, 'albums');
            const grid = document.getElementById('albums-grid');
            if (!grid) {
                console.error('albums-grid element not found!');
                return;
            }
            
            // Update showing count
            const showingCountEl = document.getElementById('showing-count');
            if (showingCountEl) {
                showingCountEl.textContent = filteredAlbums.length;
            }
            
            if (filteredAlbums.length === 0) {
                grid.innerHTML = '<div class="empty-state">No albums found matching your filters.</div>';
                return;
            }

            // Add updating class for visual feedback
            grid.classList.add('updating');
            
            // Small delay to allow transition
            setTimeout(async () => {
                const albumCards = await Promise.all(filteredAlbums.map(async (album, index) => {
                    const rating = album.rating ? `<span class="rating">‚≠ê ${album.rating}</span>` : '';
                    const country = album.country_name && album.iso_alpha_3 
                        ? `<span class="country-badge">${escapeHtml(album.country_name)}</span>`
                        : '<span class="country-badge empty">No Country</span>';
                    const spotifyLink = album.spotify_link 
                        ? `<a href="${escapeHtml(album.spotify_link)}" target="_blank" rel="noopener" class="spotify-link" onclick="event.stopPropagation()">üéµ Listen on Spotify</a>`
                        : '';
                    
                    // Album image HTML
                    const albumImageHtml = album.spotify_link 
                        ? `
                            <div class="album-image-container">
                                ${album.album_image 
                                    ? `<img src="${escapeHtml(album.album_image)}" alt="${escapeHtml(album.album || 'Album')}" class="album-image" onerror="this.style.display='none'; this.parentElement.querySelector('.album-image-placeholder').style.display='flex';">`
                                    : '<div class="album-image-loading"></div>'
                                }
                                <div class="album-image-placeholder" style="display: none;">üéµ</div>
                            </div>
                        `
                        : '';
                    
                    // If album is not listened to, we'll add suggested album later via batch loading
                    // This is done separately to improve performance
                    
                    return `
                        <div class="album-card" style="animation-delay: ${index * 0.03}s" onclick="openEditForm(${album.id})" data-album-id="${album.id}">
                            ${albumImageHtml}
                            <div class="album-title">${escapeHtml(album.album || 'Untitled')}</div>
                            <div class="album-artist">by ${escapeHtml(album.artist || 'Unknown Artist')}</div>
                            ${rating ? `<div class="album-rating-wrap">${rating}</div>` : ''}
                            <div class="album-meta">
                                ${album.listen_date ? `
                                    <div class="meta-item">
                                        <span class="meta-label">Listened:</span>
                                        <span class="meta-value">${formatDate(album.listen_date)}</span>
                                    </div>
                                ` : ''}
                                ${album.year ? `
                                    <div class="meta-item">
                                        <span class="meta-label">Year:</span>
                                        <span class="meta-value">${album.year}</span>
                                    </div>
                                ` : ''}
                            </div>
                            ${album.comments ? `
                                <div class="comments">"${escapeHtml(album.comments)}"</div>
                            ` : ''}
                            ${album.fav_tracks && album.fav_tracks.length > 0 ? `
                                <div class="album-fav-tracks">
                                    <div class="album-fav-tracks-label">Favorite Tracks</div>
                                    <div class="album-fav-tracks-list">
                                        ${album.fav_tracks.map(track => `<span class="album-fav-track-tag">${escapeHtml(track)}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div class="album-footer">
                                ${country}
                                ${spotifyLink}
                            </div>
                        </div>
                    `;
                }));
                
                grid.innerHTML = albumCards.join('');
                
                grid.classList.remove('updating');
                
                // Load album images after rendering
                loadAlbumImages();
                
                // Load suggested albums for unlistened albums in batch (after initial render for faster page load)
                loadSuggestedAlbumsBatch();
            }, 50);
        }
        
        // Cache for suggested albums to avoid repeated requests
        const suggestedAlbumsCache = {};
        
        // Load suggested albums in batch for better performance
        async function loadSuggestedAlbumsBatch() {
            // Get all unlistened albums
            const unlistenedAlbums = filteredAlbums.filter(album => !album.listen_date || album.listen_date.trim() === '');
            
            if (unlistenedAlbums.length === 0) return;
            
            // Collect unique ISO codes
            const isoCodes = [...new Set(unlistenedAlbums.map(album => {
                const iso = album.iso_alpha_3 || album.iso_code_3;
                return iso ? iso.toUpperCase().trim() : null;
            }).filter(Boolean))];
            
            // Fetch suggested albums in batch
            try {
                const response = await fetch('/api/albums/suggested-batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ iso_codes: isoCodes })
                });
                
                const suggestions = await response.json();
                
                if (suggestions && !suggestions.error) {
                    // Update each unlistened album card with its suggested album
                    unlistenedAlbums.forEach(album => {
                        const iso = (album.iso_alpha_3 || album.iso_code_3 || '').toUpperCase().trim();
                        const suggested = suggestions[iso] || suggestions['any'] || null;
                        
                        if (suggested && Object.keys(suggested).length > 0) {
                            const card = document.querySelector(`[data-album-id="${album.id}"]`);
                            if (card) {
                                const suggestedTitle = suggested.title || 'Untitled Album';
                                const suggestedArtist = suggested.artist_name || 'Unknown Artist';
                                const suggestedYear = suggested.release_year || '';
                                const suggestedGenre = suggested.genre || '';
                                
                                const suggestedHtml = `
                                    <div class="album-suggested">
                                        <div class="album-suggested-label">Suggested album</div>
                                        <div class="album-suggested-card">
                                            <div class="album-suggested-title">${escapeHtml(suggestedTitle)}</div>
                                            <div class="album-suggested-artist">by ${escapeHtml(suggestedArtist)}</div>
                                            ${suggestedYear ? `<div class="album-suggested-meta">${suggestedYear}</div>` : ''}
                                            ${suggestedGenre ? `<div class="album-suggested-meta">${escapeHtml(suggestedGenre)}</div>` : ''}
                                        </div>
                                    </div>
                                `;
                                
                                // Append to the card (before the closing div)
                                const lastChild = card.lastElementChild;
                                if (lastChild) {
                                    lastChild.insertAdjacentHTML('afterend', suggestedHtml);
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading suggested albums batch:', error);
            }
        }

        // Filter and sort albums
        function filterAndSort() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const countryFilter = document.getElementById('filter-country').value;
            const yearFilter = document.getElementById('filter-year').value;
            const listenedFilter = document.getElementById('filter-listened').value;
            const sortBy = document.getElementById('sort-select').value;

            // Filter albums
            filteredAlbums = allAlbums.filter(album => {
                const matchesSearch = !searchTerm || 
                    (album.album && album.album.toLowerCase().includes(searchTerm)) ||
                    (album.artist && album.artist.toLowerCase().includes(searchTerm));
                
                const matchesCountry = !countryFilter || album.country_name === countryFilter;
                
                // Match year filter against both release year and listen date year
                let matchesYear = !yearFilter;
                if (yearFilter) {
                    const filterYear = parseInt(yearFilter);
                    // Check release year
                    const releaseYearMatch = album.year && album.year.toString() === yearFilter;
                    // Check listen date year
                    let listenYearMatch = false;
                    if (album.listen_date) {
                        try {
                            const date = new Date(album.listen_date);
                            if (!isNaN(date.getTime())) {
                                listenYearMatch = date.getFullYear() === filterYear;
                            } else {
                                // Try to parse as string format like "05 Jan 2026, 07:51"
                                const yearMatch = album.listen_date.match(/\b(19|20)\d{2}\b/);
                                if (yearMatch && parseInt(yearMatch[0]) === filterYear) {
                                    listenYearMatch = true;
                                }
                            }
                        } catch (e) {
                            // Ignore parse errors
                        }
                    }
                    matchesYear = releaseYearMatch || listenYearMatch;
                }
                
                let matchesListened = true;
                if (listenedFilter === 'listened') {
                    matchesListened = album.listen_date && album.listen_date.trim() !== '';
                } else if (listenedFilter === 'not_listened') {
                    matchesListened = !album.listen_date || album.listen_date.trim() === '';
                }
                
                return matchesSearch && matchesCountry && matchesYear && matchesListened;
            });

            // Sort
            filteredAlbums.sort((a, b) => {
                switch(sortBy) {
                    case 'listen_date_desc':
                        return new Date(b.listen_date || 0) - new Date(a.listen_date || 0);
                    case 'listen_date_asc':
                        return new Date(a.listen_date || 0) - new Date(b.listen_date || 0);
                    case 'album_asc':
                        return (a.album || '').localeCompare(b.album || '');
                    case 'album_desc':
                        return (b.album || '').localeCompare(a.album || '');
                    case 'artist_asc':
                        return (a.artist || '').localeCompare(b.artist || '');
                    case 'artist_desc':
                        return (b.artist || '').localeCompare(a.artist || '');
                    case 'rating_desc':
                        return (parseFloat(b.rating) || 0) - (parseFloat(a.rating) || 0);
                    case 'rating_asc':
                        return (parseFloat(a.rating) || 0) - (parseFloat(b.rating) || 0);
                    case 'country_asc':
                        // Sort by country name alphabetically
                        const countryA = (a.country_name || '').trim();
                        const countryB = (b.country_name || '').trim();
                        // Empty countries go to the end
                        if (!countryA && !countryB) return 0;
                        if (!countryA) return 1;
                        if (!countryB) return -1;
                        // Direct alphabetical comparison (case-insensitive)
                        const compare = countryA.localeCompare(countryB, 'en', { sensitivity: 'base', numeric: true });
                        // If countries are the same, sort by album name as secondary sort
                        if (compare === 0) {
                            return (a.album || '').localeCompare(b.album || '');
                        }
                        return compare;
                    case 'country_desc':
                        // Sort by country name reverse alphabetically
                        const countryADesc = (a.country_name || '').trim();
                        const countryBDesc = (b.country_name || '').trim();
                        // Empty countries go to the end
                        if (!countryADesc && !countryBDesc) return 0;
                        if (!countryADesc) return 1;
                        if (!countryBDesc) return -1;
                        // Direct reverse alphabetical comparison (case-insensitive)
                        const compareDesc = countryBDesc.localeCompare(countryADesc, 'en', { sensitivity: 'base', numeric: true });
                        // If countries are the same, sort by album name as secondary sort
                        if (compareDesc === 0) {
                            return (b.album || '').localeCompare(a.album || '');
                        }
                        return compareDesc;
                    default:
                        return 0;
                }
            });

            // Render with smooth transition
            renderAlbums();
        }

        // Event listeners with debouncing for search
        let searchTimeout;
        document.getElementById('sort-select').addEventListener('change', filterAndSort);
        document.getElementById('filter-country').addEventListener('change', filterAndSort);
        document.getElementById('filter-year').addEventListener('change', filterAndSort);
        document.getElementById('filter-listened').addEventListener('change', filterAndSort);
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterAndSort, 300); // Debounce search for 300ms
        });

        // Open edit form with album data
        function openEditForm(albumId) {
            const album = allAlbums.find(a => a.id === albumId);
            if (!album) return;

            // Format date for input field (YYYY-MM-DD)
            let formattedDate = '';
            if (album.listen_date) {
                try {
                    const date = new Date(album.listen_date);
                    if (!isNaN(date.getTime())) {
                        formattedDate = date.toISOString().split('T')[0];
                    } else {
                        // Try to parse as YYYY-MM-DD or other formats
                        const parts = album.listen_date.split(/[-/]/);
                        if (parts.length === 3) {
                            // Assume format might be MM/DD/YYYY or DD/MM/YYYY
                            formattedDate = album.listen_date;
                        }
                    }
                } catch (e) {
                    formattedDate = album.listen_date;
                }
            }

            // Populate form fields
            document.getElementById('album-id').value = album.id || '';
            document.getElementById('edit-album-name').value = album.album || '';
            document.getElementById('edit-album-artist').value = album.artist || '';
            document.getElementById('edit-album-rating').value = album.rating || '';
            document.getElementById('edit-album-listen-date').value = formattedDate;
            document.getElementById('edit-album-country').value = album.country_name || '';
            document.getElementById('edit-album-iso2').value = (album.iso_alpha_2 || '').toUpperCase();
            document.getElementById('edit-album-iso').value = (album.iso_alpha_3 || '').toUpperCase();
            document.getElementById('edit-album-year').value = album.year || '';
            document.getElementById('edit-album-spotify').value = album.spotify_link || '';
            document.getElementById('edit-album-comments').value = album.comments || '';
            
            // Populate fav_tracks
            const favTracksList = document.getElementById('fav-tracks-list');
            favTracksList.innerHTML = '';
            const favTracks = album.fav_tracks || [];
            if (favTracks.length > 0) {
                favTracks.forEach(track => {
                    addFavTrack(track);
                });
            } else {
                // Add one empty track input by default
                addFavTrack();
            }

            // Show form
            const formContainer = document.getElementById('edit-album-form-container');
            formContainer.classList.add('visible');
            
            // Scroll to form
            setTimeout(() => {
                formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        // Add favorite track input
        function addFavTrack(trackValue = '') {
            const favTracksList = document.getElementById('fav-tracks-list');
            const trackItem = document.createElement('div');
            trackItem.className = 'fav-track-item';
            const trackId = Date.now() + Math.random();
            trackItem.innerHTML = `
                <input type="text" class="fav-track-input" placeholder="Track name..." value="${escapeHtml(trackValue)}">
                <button type="button" class="remove-track-btn" onclick="removeFavTrack(this)">Remove</button>
            `;
            favTracksList.appendChild(trackItem);
        }

        // Remove favorite track input
        function removeFavTrack(btn) {
            btn.parentElement.remove();
        }

        // Close edit form
        function closeEditForm() {
            const formContainer = document.getElementById('edit-album-form-container');
            formContainer.classList.remove('visible');
            document.getElementById('edit-album-form').reset();
            document.getElementById('fav-tracks-list').innerHTML = '';
            document.getElementById('form-message').className = 'form-message';
            document.getElementById('form-message').textContent = '';
        }

        // Handle edit album form submission
        document.getElementById('edit-album-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const messageDiv = document.getElementById('form-message');
            const albumId = document.getElementById('album-id').value;
            
            if (!albumId) {
                messageDiv.className = 'form-message error';
                messageDiv.textContent = 'Error: Album ID is missing';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            messageDiv.className = 'form-message';
            messageDiv.textContent = '';

            // Collect form data
            const favTracksInputs = document.querySelectorAll('.fav-track-input');
            const favTracks = Array.from(favTracksInputs)
                .map(input => input.value.trim())
                .filter(track => track !== '');

            const formData = {
                album: document.getElementById('edit-album-name').value.trim(),
                artist: document.getElementById('edit-album-artist').value.trim(),
                rating: document.getElementById('edit-album-rating').value ? parseFloat(document.getElementById('edit-album-rating').value) : null,
                listen_date: document.getElementById('edit-album-listen-date').value || null,
                country_name: document.getElementById('edit-album-country').value.trim() || null,
                iso_alpha_2: document.getElementById('edit-album-iso2').value.trim().toUpperCase() || null,
                iso_alpha_3: document.getElementById('edit-album-iso').value.trim().toUpperCase() || null,
                year: document.getElementById('edit-album-year').value ? parseInt(document.getElementById('edit-album-year').value) : null,
                spotify_link: document.getElementById('edit-album-spotify').value.trim() || null,
                comments: document.getElementById('edit-album-comments').value.trim() || null,
                fav_tracks: favTracks.length > 0 ? favTracks : null
            };

            // Remove null/empty values (but keep empty arrays)
            Object.keys(formData).forEach(key => {
                if (formData[key] === null || formData[key] === '') {
                    delete formData[key];
                }
            });
            
            // If fav_tracks is an empty array, set it to null or remove it
            if (formData.fav_tracks && formData.fav_tracks.length === 0) {
                delete formData.fav_tracks;
            }

            try {
                const response = await authenticatedFetch(`/api/albums/listened/${albumId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to update album');
                }

                // Show success message
                messageDiv.className = 'form-message success';
                messageDiv.textContent = 'Album updated successfully!';
                
                // Reload albums to show the updated data (preserving filters)
                setTimeout(() => {
                    loadAlbums(true); // Pass true to preserve filters
                    closeEditForm();
                }, 1500);

            } catch (error) {
                console.error('Error updating album:', error);
                messageDiv.className = 'form-message error';
                messageDiv.textContent = `Error: ${error.message}`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Album';
            }
        });

        // Load albums on page load
        console.log('Page loaded, calling loadAlbums');
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadAlbums);
        } else {
            loadAlbums();
        }
    </script>
</body>
</html>

