<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movies - Conor's Worldly</title>
    <link rel="stylesheet" href="/static/css/worldly.css">
    <style>
        .movies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 24px;
        }

        .movie-card {
            background: rgba(255,255,255,0.04);
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.07);
            transition: transform 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
        }

        .movie-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255,255,255,0.12);
            box-shadow: 0 20px 40px rgba(0,0,0,0.25);
        }

        .movie-card a {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .movie-poster-wrap {
            width: 100%;
            aspect-ratio: 2/3;
            position: relative;
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
        }

        .movie-poster {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .movie-poster-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.25);
            font-size: 48px;
        }

        .movie-info {
            padding: 14px;
        }

        .movie-title {
            font-size: 15px;
            font-weight: 600;
            line-height: 1.35;
            margin-bottom: 6px;
            color: white;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .movie-year {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 6px;
        }

        .movie-details {
            font-size: 12px;
            color: rgba(255,255,255,0.55);
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .movie-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }

        .source-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .source-badge.watched {
            background: rgba(102, 126, 234, 0.25);
            color: #a5b4fc;
            border: 1px solid rgba(102, 126, 234, 0.4);
        }

        .source-badge.watchlist {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }

        .source-badge.enrichment {
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.5);
            border: 1px solid rgba(255,255,255,0.15);
        }

        .movie-date {
            font-size: 11px;
            color: rgba(255,255,255,0.45);
        }

        .movie-votes {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            margin-top: 4px;
        }

        .movie-overview {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            line-height: 1.35;
            margin-top: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .filters-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: flex-end;
            margin-bottom: 28px;
            padding: 18px 22px;
            background: rgba(255,255,255,0.03);
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.06);
        }

        .filters-panel .filter-group select,
        .filters-panel .filter-group input[type="number"] { min-width: 120px; }
        .filters-panel .filter-group input[type="number"] { min-width: 80px; }

        .sort-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .stats-row {
            margin-bottom: 24px;
            font-size: 14px;
            color: rgba(255,255,255,0.6);
        }

        .stats-row strong { color: #a5b4fc; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1 class="title">Movies</h1>
            <p class="subtitle">Letterboxd watched &amp; watchlist</p>
        </div>
        <div class="top-right-nav">
            <a href="/globe" class="nav-btn">Globe</a>
            <a href="/books" class="nav-btn">Books</a>
            <a href="/movies" class="nav-btn active">Movies</a>
            <a href="/quotes" class="nav-btn">Quotes</a>
            <a href="/albums" class="nav-btn">Albums</a>
            <a href="/listening" class="nav-btn">Listening</a>
            <a href="/exercise" class="nav-btn">Exercise</a>
            <a href="/progress" class="nav-btn">Progress</a>
        </div>
    </div>

    <div class="filter-bar">
        <button type="button" class="filter-btn active" data-filter="all">All</button>
        <button type="button" class="filter-btn" data-filter="watched">Watched</button>
        <button type="button" class="filter-btn" data-filter="watchlist">Watchlist</button>
    </div>

    <div class="filters-panel">
        <div class="filter-group">
            <label for="f-genre">Genre</label>
            <select id="f-genre">
                <option value="">Any</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="f-length-min">Length (min)</label>
            <input type="number" id="f-length-min" min="0" placeholder="min" step="5">
        </div>
        <div class="filter-group">
            <label for="f-length-max">Length (max)</label>
            <input type="number" id="f-length-max" min="0" placeholder="max" step="5">
        </div>
        <div class="filter-group">
            <label for="f-year">Year</label>
            <select id="f-year">
                <option value="">Any</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="f-country">Production country</label>
            <select id="f-country">
                <option value="">Any</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="f-lang">Spoken language</label>
            <select id="f-lang">
                <option value="">Any</option>
            </select>
        </div>
        <div class="sort-row">
            <div class="filter-group">
                <label for="f-order">Sort by</label>
                <select id="f-order">
                    <option value="release_date">Release date</option>
                    <option value="vote_average">Vote average</option>
                    <option value="vote_count">Vote count</option>
                    <option value="name">Name</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="f-dir">Order</label>
                <select id="f-dir">
                    <option value="desc">Desc</option>
                    <option value="asc">Asc</option>
                </select>
            </div>
        </div>
    </div>

    <div class="stats-row" id="stats"></div>
    <div id="loading" class="loading">Loading moviesâ€¦</div>
    <div id="grid" class="movies-grid" style="display: none;"></div>

    <script>
        const gridEl = document.getElementById('grid');
        const loadingEl = document.getElementById('loading');
        const statsEl = document.getElementById('stats');
        let filterOpts = { genres: [], years: [], production_countries: [], spoken_languages: [], runtime_min: null, runtime_max: null };

        function getListFilter() {
            const btn = document.querySelector('.filter-btn.active');
            return (btn && btn.getAttribute('data-filter')) || 'all';
        }

        function buildMoviesUrl() {
            const listFilter = getListFilter();
            const params = new URLSearchParams();
            params.set('filter', listFilter);
            params.set('posters', '1');
            const genre = document.getElementById('f-genre').value;
            if (genre) params.set('genre', genre);
            const lengthMin = document.getElementById('f-length-min').value;
            if (lengthMin) params.set('length_min', lengthMin);
            const lengthMax = document.getElementById('f-length-max').value;
            if (lengthMax) params.set('length_max', lengthMax);
            const year = document.getElementById('f-year').value;
            if (year) params.set('year', year);
            const country = document.getElementById('f-country').value;
            if (country) params.set('production_country', country);
            const lang = document.getElementById('f-lang').value;
            if (lang) params.set('spoken_languages', lang);
            const orderBy = document.getElementById('f-order').value;
            if (orderBy) params.set('order_by', orderBy);
            const orderDir = document.getElementById('f-dir').value;
            if (orderDir) params.set('order_dir', orderDir);
            return '/api/movies?' + params.toString();
        }

        function setFilter(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
            });
            loadMovies();
        }

        function loadMovies() {
            gridEl.style.display = 'none';
            loadingEl.style.display = 'block';
            statsEl.textContent = '';

            fetch(buildMoviesUrl())
                .then(r => r.json())
                .then(items => {
                    loadingEl.style.display = 'none';
                    if (!Array.isArray(items)) {
                        gridEl.innerHTML = '<p class="loading">No movies found.</p>';
                        gridEl.style.display = 'block';
                        return;
                    }
                    const listFilter = getListFilter();
                    const watched = items.filter(m => m.source === 'watched').length;
                    const watchlist = items.filter(m => m.source === 'watchlist').length;
                    if (listFilter === 'all') {
                        statsEl.innerHTML = '<strong>' + items.length + '</strong> total &nbsp;|&nbsp; <strong>' + watched + '</strong> watched &nbsp;|&nbsp; <strong>' + watchlist + '</strong> watchlist';
                    } else {
                        statsEl.innerHTML = '<strong>' + items.length + '</strong> ' + listFilter;
                    }
                    gridEl.innerHTML = items.map(m => {
                        const title = escapeHtml(m.name || 'Unknown');
                        const year = m.year ? escapeHtml(m.year) : (m.release_date ? escapeHtml(String(m.release_date).slice(0, 4)) : 'â€”');
                        const date = m.date ? escapeHtml(m.date) : '';
                        const url = (m.letterboxd_uri || '#').trim();
                        const poster = m.poster_url
                            ? '<div class="movie-poster-wrap"><img class="movie-poster" src="' + escapeHtml(m.poster_url) + '" alt="" loading="lazy" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\';"><div class="movie-poster-placeholder" style="display:none;">ðŸŽ¬</div></div>'
                            : '<div class="movie-poster-wrap"><div class="movie-poster-placeholder">ðŸŽ¬</div></div>';
                        let badge = '<span class="source-badge enrichment">â€”</span>';
                        if (m.source === 'watched') badge = '<span class="source-badge watched">Watched</span>';
                        else if (m.source === 'watchlist') badge = '<span class="source-badge watchlist">Watchlist</span>';
                        const parts = [];
                        if (m.runtime_minutes) parts.push(m.runtime_minutes + ' min');
                        if (m.genres && m.genres.length) parts.push(m.genres.slice(0, 3).join(', '));
                        if (m.director) parts.push('Dir: ' + escapeHtml(m.director));
                        const details = parts.length ? '<div class="movie-details">' + parts.join(' Â· ') + '</div>' : '';
                        const votes = (m.vote_average != null || m.vote_count != null)
                            ? '<div class="movie-votes">â˜… ' + (m.vote_average != null ? Number(m.vote_average).toFixed(1) : 'â€”') + (m.vote_count != null ? ' Â· ' + m.vote_count + ' votes' : '') + '</div>'
                            : '';
                        const overview = (m.overview && m.overview.trim())
                            ? '<div class="movie-overview">' + escapeHtml(m.overview.trim()) + '</div>'
                            : '';
                        const extra = (votes || overview) ? (votes + overview) : '';
                        return '<div class="movie-card"><a href="' + escapeHtml(url) + '" target="_blank" rel="noopener">' + poster + '<div class="movie-info"><div class="movie-title">' + title + '</div><div class="movie-year">' + year + '</div>' + details + extra + '<div class="movie-meta">' + badge + '<span class="movie-date">' + date + '</span></div></div></a></div>';
                    }).join('');
                    gridEl.style.display = 'grid';
                })
                .catch(() => {
                    loadingEl.style.display = 'none';
                    gridEl.innerHTML = '<p class="loading">Failed to load movies.</p>';
                    gridEl.style.display = 'block';
                });
        }

        function escapeHtml(s) {
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function populateFilterOptions() {
            fetch('/api/movies/filters')
                .then(r => r.json())
                .then(opts => {
                    filterOpts = opts;
                    const genreSel = document.getElementById('f-genre');
                    genreSel.innerHTML = '<option value="">Any</option>' + (opts.genres || []).map(g => '<option value="' + escapeHtml(g) + '">' + escapeHtml(g) + '</option>').join('');
                    const yearSel = document.getElementById('f-year');
                    yearSel.innerHTML = '<option value="">Any</option>' + (opts.years || []).map(y => '<option value="' + escapeHtml(y) + '">' + escapeHtml(y) + '</option>').join('');
                    const countrySel = document.getElementById('f-country');
                    countrySel.innerHTML = '<option value="">Any</option>' + (opts.production_countries || []).map(c => '<option value="' + escapeHtml(c) + '">' + escapeHtml(c) + '</option>').join('');
                    const langSel = document.getElementById('f-lang');
                    langSel.innerHTML = '<option value="">Any</option>' + (opts.spoken_languages || []).map(l => '<option value="' + escapeHtml(l) + '">' + escapeHtml(l) + '</option>').join('');
                    const minIn = document.getElementById('f-length-min');
                    const maxIn = document.getElementById('f-length-max');
                    if (opts.runtime_min != null) minIn.placeholder = opts.runtime_min;
                    if (opts.runtime_max != null) maxIn.placeholder = opts.runtime_max;
                })
                .catch(() => {});
        }

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => setFilter(btn.getAttribute('data-filter')));
        });
        document.getElementById('f-genre').addEventListener('change', loadMovies);
        document.getElementById('f-length-min').addEventListener('change', loadMovies);
        document.getElementById('f-length-max').addEventListener('change', loadMovies);
        document.getElementById('f-year').addEventListener('change', loadMovies);
        document.getElementById('f-country').addEventListener('change', loadMovies);
        document.getElementById('f-lang').addEventListener('change', loadMovies);
        document.getElementById('f-order').addEventListener('change', loadMovies);
        document.getElementById('f-dir').addEventListener('change', loadMovies);

        populateFilterOptions();
        setFilter('all');
    </script>
</body>
</html>
